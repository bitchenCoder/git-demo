<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>几何体-自定义几何体</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        background: none;
        width: 1860px;
        height: 953px;

        /* background-color: rgba(0, 0, 255, 0) !important; */
      }

      #range {
        cursor: pointer;
      }
      .btn1 {
        position: absolute;
        left: 0;
        top: 0;
        font-size: 36px;
      }
      .btn2 {
        position: absolute;
        left: 0;
        top: 100px;
        font-size: 36px;
      }
      .btn3 {
        position: absolute;
        left: 0;
        top: 200px;
        font-size: 36px;
      }
    </style>
  </head>

  <body>
    <!-- <div class="btn1" onclick="hide(1)">开/关 第一层</div> -->
    <!-- <div class="btn2" onclick="hide(2)">开/关 第二层</div> -->
    <!-- <div class="btn3" onclick="hide(3)">开/关 第三层</div> -->
    <!-- 爆炸：
    <input id="checkbox" type="checkbox" oninput="test(event)" />
    爆炸滑动条：
    <input id="range" type="range" oninput="test_(event)" value="0" />
    汽车引擎盖颜色：
    <input id="color" type="color" oninput="color_(event)" /> -->
    <!-- <script src="./three1.js"></script>
    <script src="./OrbitControls2.js"></script>
    <script src="./Geometry.js"></script> -->
    <script type="module">
      import * as THREE from "./three.module.js";
      import { OrbitControls } from "./OrbitControls.js";
      import { GLTFLoader } from "./GLTFLoader.js";
      import ModelSplit from "./ttt.js";
      import { CSS2DRenderer, CSS2DObject } from "./CSS2DRenderer.js";
      //创建场景
      const scene = new THREE.Scene();
      window.scene = scene
      // 创建正交相机
      // const camera = new THREE.OrthographicCamera(
      //   -window.innerWidth / 2,
      //   window.innerWidth / 2,
      //   window.innerHeight / 2,
      //   -window.innerHeight / 2,
      //   0.1,
      //   1000
      // );
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.x = 53.158660789038585;
      camera.position.y = 64.53698061191731;
      camera.position.z = 46.2171310116021;

      // camera.lookAt(0, 0, 0);
      // 创建渲染器
      const renderer = new THREE.WebGLRenderer({
        antialias: true,
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x000000, 0);
      // 把场景canvas添加到body标签里面
      document.body.appendChild(renderer.domElement);
      // 环境光
      const light = new THREE.AmbientLight(0x404040); // soft white light
      light.position.set(50, 50, 50);
      scene.add(light);

      //   添加平行光

      // 上边灯光
      const dirLight = new THREE.DirectionalLight(0xffffff);
      dirLight.position.set(0, 0, 2);
      dirLight.layers.enableAll();
      scene.add(dirLight);

      // 前面灯光
      const dirLight1 = new THREE.DirectionalLight(0xffffff, 0.1);
      dirLight1.position.set(2, 0, 0);
      dirLight1.layers.enableAll();
      scene.add(dirLight1);

      // const dirLight1 = new THREE.DirectionalLight(0xffffff);
      // dirLight1.position.set(0, 2, 0);
      // dirLight1.layers.enableAll();
      // scene.add(dirLight1);
      // const dirLight2 = new THREE.DirectionalLight(0xffffff);
      // dirLight2.position.set(2, 0, 0);
      // dirLight2.layers.enableAll();
      // scene.add(dirLight2);
      // const dirLight3 = new THREE.DirectionalLight(0xffffff);
      // dirLight.position.set(0, 0, -2);
      // dirLight.layers.enableAll();
      // scene.add(dirLight3);

      // 后面灯光
      const dirLight4 = new THREE.DirectionalLight(0xffffff);
      dirLight.position.set(-2, 0, 0);
      dirLight.layers.enableAll();
      scene.add(dirLight4);
      // 点光源
      // const pointLightt = new THREE.PointLight( 0xff0000, 1, 100 );
      // pointLightt.position.set( 50, 50, 50 );
      // pointLightt.castShadow = true;
      // pointLightt.shadow.camera.near = 1;
      // pointLightt.shadow.camera.far = 5000;
      const pointLightt = new THREE.SpotLight(0xffffff);
      pointLightt.position.set(-2, 4, 0);
      // scene.add(pointLightt);
      //辅助线
      // const axesHelper = new THREE.AxesHelper(3);
      // scene.add(axesHelper);

      // 拆分
      window.modelSplit = new ModelSplit();

      // let cf = document.getElementById("cf");
      // cf.addEventListener("click", () => {
      //   console.log(999);
      //   modelSplit.startSplit();
      // });

      // let range = document.getElementById("range");
      // range.addEventListener("onpropertychange", (e) => {
      //   console.log(111);
      // });
      // range.addEventListener("oninput", (e) => {
      //   console.log(111);
      // });
      // range.addEventListener("onchange", (e) => {
      //   console.log(111);
      // });
      // 模型
      const loader = new GLTFLoader();
      const group_1 = new THREE.Group();
      const group_2 = new THREE.Group();
      const group_3 = new THREE.Group();
      loader.load(
        "./1.glb",
        function (gltf) {
          console.log(gltf.scene.children[0].children);

          modelSplit.setSplitModel(gltf.scene);
          // modelSplit.setValue(0.1);
          window.gltf1 = gltf;
          // ltf.scene.scale.set(1, 1, 1);
          gltf.scene.scale.setScalar(1);
          gltf.scene.rotation.y = 30.1;
          gltf.scene.position.y = 0;
          gltf.scene.position.x = -20;
          gltf.scene.position.z = -30;
          console.log(gltf.scene);
          gltf.scene.traverse(function (child) {
            if (child instanceof THREE.Mesh) {
              if (child.material.name == "幕墙玻璃") {
                child.material.opacity = 0.4;
                child.material.transparent = true;
                child.material.depthWrite = false;
                // child.material.emissive = cfcfcf;
                // child.material.color = new color(0xffffff);
                child.material.emissive = child.material.color;
              }
              child.castShadow = true; //阴影
              child.receiveShadow = true; //接受别人投的阴影
            }
          });
          scene.add(gltf.scene);
        },
        function (error) {
          // console.error(error);
        }
      );
      loader.load(
        "./2.glb",
        function (gltf) {
          console.log(gltf.scene.children[0].children);

          modelSplit.setSplitModel(gltf.scene);
          // modelSplit.setValue(0.1);
          window.gltf2 = gltf;
          // ltf.scene.scale.set(1, 1, 1);
          gltf.scene.scale.setScalar(1);
          gltf.scene.rotation.y = 30.1;
          gltf.scene.position.y = 0;
          gltf.scene.position.x = -20;
          gltf.scene.position.z = -30;
          console.log(gltf.scene);
          gltf.scene.traverse(function (child) {
            if (child instanceof THREE.Mesh) {
              if (child.material.name == "幕墙玻璃") {
                child.material.opacity = 0.4;
                child.material.transparent = true;
                child.material.depthWrite = false;
                // child.material.emissive = cfcfcf;
                // child.material.color = new color(0xffffff);
                child.material.emissive = child.material.color;
              }
              child.castShadow = true; //阴影
              child.receiveShadow = true; //接受别人投的阴影
            }
          });
          scene.add(gltf.scene);
        },
        function (error) {
          // console.error(error);
        }
      );
      loader.load(
        "./3.glb",
        function (gltf) {
          console.log(gltf.scene.children[0].children);

          modelSplit.setSplitModel(gltf.scene);
          // modelSplit.setValue(0.1);
          window.gltf3 = gltf;
          // ltf.scene.scale.set(1, 1, 1);
          gltf.scene.scale.setScalar(1);
          gltf.scene.rotation.y = 30.1;
          gltf.scene.position.y = 0;
          gltf.scene.position.x = -20;
          gltf.scene.position.z = -30;
          console.log(gltf.scene);
          gltf.scene.traverse(function (child) {
            if (child instanceof THREE.Mesh) {
              if (child.material.name == "幕墙玻璃") {
                child.material.opacity = 0.4;
                child.material.transparent = true;
                child.material.depthWrite = false;
                // child.material.emissive = cfcfcf;
                // child.material.color = new color(0xffffff);
                child.material.emissive = child.material.color;
              }
              child.castShadow = true; //阴影
              child.receiveShadow = true; //接受别人投的阴影
            }
          });
          scene.add(gltf.scene);
        },
        function (error) {
          // console.error(error);
        }
      );

      

      

      function animate() {
        requestAnimationFrame(animate);
        // modelSplit.startSplit();
        renderer.render(scene, camera);
      }
      animate();

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.addEventListener("change", animate());
      controls.addEventListener("end", () => {
        console.log(camera.position.x, camera.position.y, camera.position.z);
      });
    </script>
    <script>
      function disposeObject(obj) {
        if (obj.children) {
          obj.children.forEach((child) => {
            disposeObject(child);
          });
        }

        if (obj.geometry) {
          obj.geometry.dispose();
        }

        if (obj.material) {
          if (Array.isArray(obj.material)) {
            obj.material.forEach((material) => {
              material.dispose();
            });
          } else {
            obj.material.dispose();
          }
        }
      }
      window.addEventListener("message", (event) => {
        console.log("message: " + event.data);
        if (event.data == 1) {
          hide(1);
        } else if (event.data == 2) {
          hide(2);
        } else if (event.data == 3) {
          hide(3);
        }else if(event.data=='dispose'){
          // 递归销毁场景中的对象
          disposeObject(window.scene);
        }
      });
      function hide(i) {
        if (i == 1) {
          if (window.gltf1.scene.visible) {
            window.gltf1.scene.visible = false;
          } else {
            window.gltf1.scene.visible = true;
          }
        } else if (i == 2) {
          if (window.gltf2.scene.visible) {
            window.gltf2.scene.visible = false;
          } else {
            window.gltf2.scene.visible = true;
          }
        } else if (i == 3) {
          if (window.gltf3.scene.visible) {
            window.gltf3.scene.visible = false;
          } else {
            window.gltf3.scene.visible = true;
          }
        }
      }
      // function test(e) {
      //   console.log(e.target.checked);
      //   if (e.target.checked) {
      //     let range = document.getElementById("range");
      //     range.value = 100;
      //     window.modelSplit.setValue(100 / 200);
      //   } else {
      //     let range = document.getElementById("range");
      //     range.value = 0;
      //     window.modelSplit.setValue(0 / 200);
      //   }
      // }
      // function test_(e) {
      //   console.log(e.target.value);
      //   if (e.target.value == 0) {
      //     let checkbox = document.getElementById("checkbox");
      //     checkbox.checked = false;
      //   }
      //   if (e.target.value == 100) {
      //     let checkbox = document.getElementById("checkbox");
      //     checkbox.checked = true;
      //   }

      //   window.modelSplit.setValue(e.target.value / 200);
      // }
      // function color_(e) {
      //   window.gltf.scene.children[0].children[0].children[0].traverse(
      //     (child) => {
      //       if (child.isMesh) {
      //         child.material.color.set(`${e.target.value}`);
      //       }
      //     }
      //   );
      // }
    </script>
  </body>
</html>
